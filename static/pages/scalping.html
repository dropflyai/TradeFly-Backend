<div class="page-header">
    <h1 class="page-title">âš¡ Scalping Signals</h1>
    <p class="page-subtitle">Fast 0-7 DTE options plays | Quick entries and exits</p>
</div>

<!-- Stats Summary -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Active Signals</div>
        <div class="stat-value" id="scalp-active-count">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Avg Confidence</div>
        <div class="stat-value" id="scalp-avg-confidence">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">In Paper Trading</div>
        <div class="stat-value" id="scalp-paper-count">-</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Win Rate (7d)</div>
        <div class="stat-value stat-up" id="scalp-win-rate">-</div>
    </div>
</div>

<!-- Controls -->
<div class="card mb-3">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <label style="color: var(--text-secondary); margin-right: 1rem;">Min Confidence:</label>
            <select id="scalp-min-confidence" style="padding: 0.5rem; border-radius: 0.375rem; background: var(--dark-bg); color: var(--text-primary); border: 1px solid var(--border-color);">
                <option value="0.80">80%</option>
                <option value="0.85" selected>85%</option>
                <option value="0.90">90%</option>
                <option value="0.95">95%</option>
            </select>
        </div>
        <button class="btn btn-primary" id="scalp-refresh-btn">ðŸ”„ Refresh Signals</button>
    </div>
</div>

<!-- Signals Grid -->
<div id="scalp-signals-container">
    <div class="loading">Loading scalping signals...</div>
</div>

<script>
// Scalping Page Logic
const ScalpingPage = {
    signals: [],
    minConfidence: 0.85,

    async init() {
        console.log('Initializing Scalping page');

        // Set up event listeners
        document.getElementById('scalp-refresh-btn').addEventListener('click', () => this.loadSignals());
        document.getElementById('scalp-min-confidence').addEventListener('change', (e) => {
            this.minConfidence = parseFloat(e.target.value);
            this.loadSignals();
        });

        // Load initial data
        await this.loadSignals();
        await this.loadStats();

        // Auto-refresh every 30 seconds
        setInterval(() => this.loadSignals(), 30000);
    },

    async loadSignals() {
        try {
            const response = await fetch(`/api/options/signals?strategy=SCALPING&min_confidence=${this.minConfidence}&max_results=20`);
            const signals = await response.json();
            this.signals = signals;
            this.renderSignals(signals);
        } catch (error) {
            console.error('Error loading signals:', error);
            document.getElementById('scalp-signals-container').innerHTML = '<div class="empty-state">Error loading signals</div>';
        }
    },

    async loadStats() {
        try {
            const response = await fetch('/api/paper/stats');
            const stats = await response.json();

            document.getElementById('scalp-active-count').textContent = this.signals.length;
            document.getElementById('scalp-avg-confidence').textContent =
                this.signals.length > 0
                    ? (this.signals.reduce((sum, s) => sum + s.confidence, 0) / this.signals.length * 100).toFixed(0) + '%'
                    : '0%';

            // Count scalping signals in paper trading
            const scalpingInPaper = stats.strategies?.SCALPING?.sample_size || 0;
            document.getElementById('scalp-paper-count').textContent = scalpingInPaper;

            // Win rate from paper trading stats
            const winRate = stats.strategies?.SCALPING?.win_rate || 0;
            document.getElementById('scalp-win-rate').textContent = (winRate * 100).toFixed(1) + '%';
        } catch (error) {
            console.error('Error loading stats:', error);
        }
    },

    renderSignals(signals) {
        const container = document.getElementById('scalp-signals-container');

        if (!signals || signals.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âš¡</div>
                    <p>No scalping signals found at ${(this.minConfidence * 100).toFixed(0)}% confidence</p>
                    <p class="text-muted">Try lowering the minimum confidence threshold</p>
                </div>
            `;
            return;
        }

        container.innerHTML = signals.map(signal => this.renderSignalCard(signal)).join('');

        // Attach event listeners to quick-add buttons
        signals.forEach(signal => {
            const btn = document.getElementById(`quick-add-${signal.signal_id}`);
            if (btn) {
                btn.addEventListener('click', () => this.quickAddToPaper(signal));
            }
        });
    },

    renderSignalCard(signal) {
        const confidenceClass = signal.confidence >= 0.90 ? 'confidence-high' : 'confidence-medium';
        const actionColor = signal.action.includes('CALL') ? 'var(--success-color)' : 'var(--danger-color)';

        return `
            <div class="signal-card">
                <div class="signal-header">
                    <div>
                        <div class="signal-symbol">${signal.symbol}</div>
                        <div class="text-muted" style="font-size: 0.875rem;">${signal.strategy}</div>
                    </div>
                    <div class="signal-confidence ${confidenceClass}">
                        ${(signal.confidence * 100).toFixed(0)}% Confidence
                    </div>
                </div>

                <div class="signal-details">
                    <div class="signal-detail">
                        <span class="signal-detail-label">Action:</span>
                        <span class="signal-detail-value" style="color: ${actionColor};">${signal.action}</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">Strike:</span>
                        <span class="signal-detail-value">$${signal.strike.toFixed(2)}</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">Entry:</span>
                        <span class="signal-detail-value">$${signal.suggested_entry.toFixed(2)}</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">Target:</span>
                        <span class="signal-detail-value text-success">$${signal.target_price.toFixed(2)} (+${signal.target_profit_percent.toFixed(0)}%)</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">Stop:</span>
                        <span class="signal-detail-value text-danger">$${signal.stop_loss.toFixed(2)} (${signal.stop_loss_percent.toFixed(0)}%)</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">DTE:</span>
                        <span class="signal-detail-value">${signal.dte} days</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">Delta:</span>
                        <span class="signal-detail-value">${signal.delta.toFixed(2)}</span>
                    </div>
                    <div class="signal-detail">
                        <span class="signal-detail-label">IV Rank:</span>
                        <span class="signal-detail-value">${signal.iv_rank.toFixed(0)}%</span>
                    </div>
                </div>

                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <strong>Reasoning:</strong>
                    <p class="text-muted" style="margin-top: 0.5rem; font-size: 0.875rem;">${signal.reasoning}</p>
                </div>

                <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
                    <button class="btn btn-primary" id="quick-add-${signal.signal_id}" style="flex: 1;">
                        âž• Quick Add to Paper Trading
                    </button>
                    <button class="btn btn-success btn-sm" onclick="alert('Real trading coming soon!')">
                        ðŸš€ Trade Live
                    </button>
                </div>
            </div>
        `;
    },

    async quickAddToPaper(signal) {
        const btn = document.getElementById(`quick-add-${signal.signal_id}`);
        const originalText = btn.innerHTML;

        try {
            btn.innerHTML = 'â³ Adding...';
            btn.disabled = true;

            const response = await fetch('/api/paper/quick-add-signal', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(signal)
            });

            const result = await response.json();

            if (result.status === 'added') {
                btn.innerHTML = 'âœ… Added to Paper Trading!';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');

                // Reload stats
                await this.loadStats();

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                    btn.disabled = false;
                }, 2000);
            } else if (result.status === 'already_exists') {
                btn.innerHTML = 'âœ“ Already in Paper Trading';
                btn.disabled = true;
            }
        } catch (error) {
            console.error('Error adding to paper trading:', error);
            btn.innerHTML = 'âŒ Error';
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        }
    }
};

// Initialize when page loads
ScalpingPage.init();
</script>
